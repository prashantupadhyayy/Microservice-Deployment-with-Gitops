name: CD - Deploy Todo App to AKS (Manifests)

on:
  workflow_dispatch:   # manually run from GitHub UI

permissions:
  id-token: write      # for OIDC login
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ACR_NAME: ${{ secrets.ACR_NAME }}
      ACR_LOGIN_SERVER: ${{ secrets.ACR_NAME }}.azurecr.io
      AKS_NAME: ${{ secrets.AKS_NAME }}
      AKS_RG: ${{ secrets.AKS_RG }}

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group "$AKS_RG" \
          --name "$AKS_NAME" \
          --overwrite-existing

    # OPTIONAL: pehli baar jab cluster me resources create karne ho
    - name: Apply Kubernetes manifests
      run: |
        # yahan path apne repo ke hisaab se change kar sakta hai
        kubectl apply -f k8s/

    - name: Update images to latest build tag
      run: |
        TAG=${{ github.run_number }}
        ACR="$ACR_LOGIN_SERVER"

        services=("AddTaskTodoMicroservice" "DeleteTaskTodoMicroservice" "GetTasksTodoMicroservice" "MicroTodoUI")

        for svc in "${services[@]}"; do
          dep=${svc,,}   # lower case deployment name
          image="$ACR/${svc,,}:$TAG"

          echo "ðŸš€ Updating deployment '$dep' to image '$image'"

          # yahan maine assume kiya container name == deployment name
          kubectl set image deployment/$dep $dep=$image -n default

          # rollout complete hone ka wait
          kubectl rollout status deployment/$dep -n default
        done

    - name: Show pods
      run: |
        kubectl get pods -n default -o wide
