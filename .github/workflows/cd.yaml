name: CD - Deploy Todo App to AKS (Manifests)

on:
  workflow_dispatch:
    inputs:
      imageTag:
        description: "Docker image tag to deploy (e.g. 12)"
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ACR_NAME: ${{ secrets.ACR_NAME }}
      ACR_LOGIN_SERVER: ${{ secrets.ACR_NAME }}.azurecr.io
      AKS_NAME: ${{ secrets.AKS_NAME }}
      AKS_RG: ${{ secrets.AKS_RG }}
      IMAGE_TAG: ${{ github.event.inputs.imageTag }}

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Get AKS credentials (admin)
      run: |
        az aks get-credentials \
          --resource-group "$AKS_RG" \
          --name "$AKS_NAME" \
          --admin \
          --overwrite-existing

    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f k8s/

    - name: Update images to given tag
      run: |
        TAG="$IMAGE_TAG"
        ACR="$ACR_LOGIN_SERVER"
        services=("AddTaskTodoMicroservice" "DeleteTaskTodoMicroservice" "GetTasksTodoMicroservice" "MicroTodoUI")

        for svc in "${services[@]}"; do
          dep=${svc,,}
          image="$ACR/${svc,,}:$TAG"

          echo "ðŸš€ Updating deployment '$dep' to image '$image'"
          kubectl set image deployment/$dep $dep=$image -n default
          kubectl rollout status deployment/$dep -n default
        done

    - name: Show pods
      run: |
        kubectl get pods -n default -o wide
