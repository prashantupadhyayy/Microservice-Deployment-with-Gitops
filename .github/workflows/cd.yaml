name: CD - Deploy Todo App to AKS (Manifests)

on:
  workflow_dispatch:
    inputs:
      imageTag:
        description: "Docker image tag to deploy (e.g. 19)"
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ACR_LOGIN_SERVER: ${{ secrets.ACR_NAME }}.azurecr.io
      AKS_NAME: ${{ secrets.AKS_NAME }}
      AKS_RG: ${{ secrets.AKS_RG }}
      IMAGE_TAG: ${{ github.event.inputs.imageTag }}

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Get AKS admin credentials
      run: |
        echo "üîê Fetching AKS Admin Credentials"
        az aks get-credentials \
          --resource-group "$AKS_RG" \
          --name "$AKS_NAME" \
          --admin \
          --overwrite-existing

    - name: Apply manifests
      run: |
        echo "üì¶ Applying manifests from all microservices..."
        kubectl apply -f AddTaskTodoMicroservice/manifests/
        kubectl apply -f DeleteTaskTodoMicroservice/manifests/
        kubectl apply -f GetTasksTodoMicroservice/manifests/
        kubectl apply -f MicroTodoUI/manifests/
        kubectl get deploy -n default

    - name: Update deployed images
      run: |
        TAG="$IMAGE_TAG"
        ACR="$ACR_LOGIN_SERVER"

        echo "üöÄ Updating images with tag: $TAG"

        kubectl set image deployment/addtasktodomicroservice addtasktodomicroservice=$ACR/addtasktodomicroservice:$TAG -n default
        kubectl rollout status deployment/addtasktodomicroservice -n default

        kubectl set image deployment/deletetasktodomicroservice deletetasktodomicroservice=$ACR/deletetasktodomicroservice:$TAG -n default
        kubectl rollout status deployment/deletetasktodomicroservice -n default

        kubectl set image deployment/gettaskstodomicroservice gettaskstodomicroservice=$ACR/gettaskstodomicroservice:$TAG -n default
        kubectl rollout status deployment/gettaskstodomicroservice -n default

        kubectl set image deployment/microtodoui microtodoui=$ACR/microtodoui:$TAG -n default
        kubectl rollout status deployment/microtodoui -n default

    - name: Show pods
      run: |
        kubectl get pods -n default -o wide
