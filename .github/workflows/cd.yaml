name: CD - Deploy Todo App to AKS (Manifests)

on:
  workflow_dispatch:
    inputs:
      imageTag:
        description: "Docker image tag to deploy (e.g. 19)"
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      ACR_NAME: ${{ secrets.ACR_NAME }}
      ACR_LOGIN_SERVER: ${{ secrets.ACR_NAME }}.azurecr.io
      AKS_NAME: ${{ secrets.AKS_NAME }}
      AKS_RG: ${{ secrets.AKS_RG }}
      IMAGE_TAG: ${{ github.event.inputs.imageTag }}

      # üëáüëá Yahan apne actual deployment + container names set karo
      ADDTASK_DEPLOYMENT: addtasktodomicroservice
      ADDTASK_CONTAINER: addtasktodomicroservice

      DELETETASK_DEPLOYMENT: deletetasktodomicroservice
      DELETETASK_CONTAINER: deletetasktodomicroservice

      GETTASKS_DEPLOYMENT: gettaskstodomicroservice
      GETTASKS_CONTAINER: gettaskstodomicroservice

      UI_DEPLOYMENT: microtodoui
      UI_CONTAINER: microtodoui

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Get AKS admin credentials
      run: |
        echo "üîê Fetching AKS Admin Credentials"
        az aks get-credentials \
          --resource-group "$AKS_RG" \
          --name "$AKS_NAME" \
          --admin \
          --overwrite-existing

    # NOTE: apply step hata diya hai kyunki k8s/ folder nahi hai.
    # Deployments already cluster me bane hone chahiye.

    - name: Update deployed images
      run: |
        set -e
        TAG="$IMAGE_TAG"
        ACR="$ACR_LOGIN_SERVER"

        echo "Using image tag: $TAG"

        # AddTaskTodoMicroservice
        DEPLOY="$ADDTASK_DEPLOYMENT"
        CONT="$ADDTASK_CONTAINER"
        IMAGE="$ACR/addtasktodomicroservice:$TAG"
        echo "üöÄ Updating $DEPLOY -> $IMAGE"
        if kubectl get deploy "$DEPLOY" -n default >/dev/null 2>&1; then
          kubectl set image deployment/$DEPLOY $CONT=$IMAGE -n default
          kubectl rollout status deployment/$DEPLOY -n default
        else
          echo "‚ö†Ô∏è Deployment $DEPLOY not found. Available deployments:"
          kubectl get deploy -n default
          exit 1
        fi

        # DeleteTaskTodoMicroservice
        DEPLOY="$DELETETASK_DEPLOYMENT"
        CONT="$DELETETASK_CONTAINER"
        IMAGE="$ACR/deletetasktodomicroservice:$TAG"
        echo "üöÄ Updating $DEPLOY -> $IMAGE"
        if kubectl get deploy "$DEPLOY" -n default >/dev/null 2>&1; then
          kubectl set image deployment/$DEPLOY $CONT=$IMAGE -n default
          kubectl rollout status deployment/$DEPLOY -n default
        else
          echo "‚ö†Ô∏è Deployment $DEPLOY not found. Available deployments:"
          kubectl get deploy -n default
          exit 1
        fi

        # GetTasksTodoMicroservice
        DEPLOY="$GETTASKS_DEPLOYMENT"
        CONT="$GETTASKS_CONTAINER"
        IMAGE="$ACR/gettaskstodomicroservice:$TAG"
        echo "üöÄ Updating $DEPLOY -> $IMAGE"
        if kubectl get deploy "$DEPLOY" -n default >/dev/null 2>&1; then
          kubectl set image deployment/$DEPLOY $CONT=$IMAGE -n default
          kubectl rollout status deployment/$DEPLOY -n default
        else
          echo "‚ö†Ô∏è Deployment $DEPLOY not found. Available deployments:"
          kubectl get deploy -n default
          exit 1
        fi

        # MicroTodoUI
        DEPLOY="$UI_DEPLOYMENT"
        CONT="$UI_CONTAINER"
        IMAGE="$ACR/microtodoui:$TAG"
        echo "üöÄ Updating $DEPLOY -> $IMAGE"
        if kubectl get deploy "$DEPLOY" -n default >/dev/null 2>&1; then
          kubectl set image deployment/$DEPLOY $CONT=$IMAGE -n default
          kubectl rollout status deployment/$DEPLOY -n default
        else
          echo "‚ö†Ô∏è Deployment $DEPLOY not found. Available deployments:"
          kubectl get deploy -n default
          exit 1
        fi

    - name: Show pods
      run: |
        kubectl get pods -n default -o wide
